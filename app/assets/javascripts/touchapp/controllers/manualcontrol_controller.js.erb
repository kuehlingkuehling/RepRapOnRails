touchApp.controller('ManualcontrolController', function($scope, $timeout, $modal, MyWebsocket){
  console.log("Running ManualcontrolController");
  
  $scope.ext_name = null;
  $scope.temp_left = 0;
  $scope.temp_right = 0;

  $scope.deviation = 10; // +/- C deviation around target temp
  $scope.extruder_temp = 0;  
  $scope.extruder_preheated = false;
  $scope.extruder_target = 0;

  $scope.$watch(function(){ return MyWebsocket.filamentsLoaded; }, function(newValue){
    $scope.filaments_loaded = MyWebsocket.filamentsLoaded;

    if ( $scope.filaments_loaded.left ) {
      $scope.temp_left = $scope.filaments_loaded.left.extrusion_temp;
    } else {
      $scope.temp_left = 180;
    }

    if ( $scope.filaments_loaded.right ) {
      $scope.temp_right = $scope.filaments_loaded.right.extrusion_temp;
    } else {
      $scope.temp_right = 180;
    }    
  }, true);


  $scope.$watch(function(){ return MyWebsocket.temp; }, function(newValue){
    $scope.temp = MyWebsocket.temp;

    if ( ( $scope.ext_name == 'left_extruder') && MyWebsocket.temp.left_extruder) {
      $scope.extruder_temp = MyWebsocket.temp.left_extruder.temp;
      $scope.extruder_target = MyWebsocket.temp.left_extruder.target;
      if (($scope.extruder_temp > ($scope.extruder_target - $scope.deviation)) && ($scope.extruder_temp < ($scope.extruder_target + $scope.deviation))) {
        $scope.extruder_preheated = true;
      } else {
        $scope.extruder_preheated = false;      
      };
    };

    if ( ( $scope.ext_name == 'right_extruder') && MyWebsocket.temp.right_extruder) {
      $scope.extruder_temp = MyWebsocket.temp.right_extruder.temp;
      $scope.extruder_target = MyWebsocket.temp.right_extruder.target;
      if (($scope.extruder_temp > ($scope.extruder_target - $scope.deviation)) && ($scope.extruder_temp < ($scope.extruder_target + $scope.deviation))) {
        $scope.extruder_preheated = true;
      } else {
        $scope.extruder_preheated = false;      
      };
    };
  }, true); 

 
  $scope.$watch(function(){ return MyWebsocket.print; }, function(newValue){
    if (( MyWebsocket.print.state == 1) || ( MyWebsocket.print.state == 3 )) {
      $scope.disable_buttons = false;
    } else {
      $scope.disable_buttons = true;      
    }    
  }, true);  

  $scope.$watch(function(){ return MyWebsocket.isDualExtruder; }, function(){
    $scope.isDualExtruder = MyWebsocket.isDualExtruder;
    if (!$scope.isDualExtruder) {
      $scope.ext_name = 'left_extruder'
    } 
  },true); 
  

  $scope.getExtId = function(){
    ext_id = ( $scope.ext_name == 'left_extruder' ) ? 0 : ( ( $scope.ext_name == 'right_extruder' ) ? 1 : null );
    return ext_id;
  }

  // relative positioning
  $scope.move = function( coord ){
    MyWebsocket.move(coord);
  }; 
   
  $scope.macro = function( name ){
    MyWebsocket.macro(name);    
  };   

  $scope.dec = function( val ){
    if ($scope.ext_name == 'left_extruder') {
      $scope.temp_left -= val;
      if ($scope.temp_left < 0) {
        $scope.temp_left = 0;
      }
    }
    if ($scope.ext_name == 'right_extruder') {
      $scope.temp_right -= val;
      if ($scope.temp_right < 0) {
        $scope.temp_right = 0;
      }
    }    
  };

  $scope.inc = function( val ){
    if ($scope.ext_name == 'left_extruder') {
      $scope.temp_left += val;
    }
    if ($scope.ext_name == 'right_extruder') {
      $scope.temp_right += val;
    }
  };
  
  $scope.set = function(){
    if ( $scope.ext_name == 'left_extruder') {
      MyWebsocket.set_temp([0, $scope.temp_left]);
    }
    if ( $scope.ext_name == 'right_extruder') {
      MyWebsocket.set_temp([1, $scope.temp_right]);
    }
  }; 

  $scope.off = function(){
    MyWebsocket.set_temp([$scope.getExtId(), 0]);
  };   
  
  $scope.extrude = function( length ){
    MyWebsocket.extrude([$scope.getExtId(), length]);    
  };     

});